1. # 规划目的

   ###### **解决**当前“多套系统”导致的各种**痛点**，包括但不限于：

   - 维护困难
   - 难以使用
   - 扩展困难，重复建设
   - 数据获取艰难，实时性准确性不足
   - 随着生产/配套的需求增长，以上的疼痛度会成比例增加

   ###### 适应内外部趋势变化

   - 内部提倡现有业务稳定基础上，挖掘新业务新方向
   - 外部企业从信息化，快速进入数字化、数智化时代	

2. # 规划目标

   为避免落地的系统和规划很不一致的现象，将上述目的转换为可衡量的目标：

   - 所有清结算系统一成**1套架构**支撑，可按需部署在不同集群
   - 所有实时交易统一成**1套架构**支撑(除天猫)，可按需部署在不同集群
   - 生产数据标准化：各业务域、模型、字段、指标命名等有统一规范
   - 生产数据有明确的分类；每类有明确存储方式、获取方式、加工方式、使用方法
   - 内部运营管理类应用归集成一套系统
   - 外部运营服务类应用归集成一套系统

   **简要的说就是：技术统一，数据统一， *文化统一***

4. # 功能规划

   ## 总体功能框架

![image-20191024113204505](https://tva1.sinaimg.cn/large/006y8mN6gy1g8aipqoomdj316c0gogu0.jpg)

​	根据工作思路，将按业务和数据特性进行划分系统功能，并归类成后台、中台、前台及运维。其中中台分为业务中台和数据中台。中后台能力更强，前台更轻便，赋予**业务人员快速试错的能力**。

- 业务前台：包括外部商户系统及商户服务等原配套功能（*具体划分待定*）。整体原则是业务前台做轻、小、薄，只做个性化的展示、操控及少量计算。

- 业务中台：按功能聚合原则中心；每个中心统一架构、统一数据模型。

  - 支付、充值、计费中心：按三大产品线原实时交易部分划分三大中心
  - 对账中心、结算：负责所有产品线的对账、结算操作
  - 用户中心：统一管理所有前台的用户验证、权限等功能；统一管理商户交易权限；统一对接4A
  - 虚户中心：提供账户管理功能
  - 签到签退：主要给省公司提供签到签退功能；
  
- 数据中台：提供复杂查询、分析统计功能。由于业务中台的架构和数据模型更多是针对OLTP的业务，需要重新组织数据以达到上述目的。

  - 数据API：提供像业务前台统一数据访问接口
  - ...

- 后台：将原个业务系统相似的、业务无关的功能统一成独立服务，供各中台复用。

  - 统一公参：包含交易权限管理服务、局数据同步服务和局数据查询服务。交易权限管理服务对接运营中心前台，通过运营中心前台可对商户的交易权限进行修改；局数据同步服务对接一级BDC，解析文件并更新局数据；局数据查询服务提供局数据的查询接口供业务中台调用。

- 运维：统一监控、运维保障有前中后台服务。此处不限定自研，优先复用公司现有的成熟系统  

  以上服务均需考虑多中心场景。
  
  > 中台可以理解为积木；前台利用积木搭建房子等各式各样的成品，但不会重复造积木。
  
  ## 总体数据流

一切业务数据化、一切数据业务化

<img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g8aiqpaupkj30y60gu0xd.jpg" alt="image-20191025161921636" style="zoom:50%;" />

  5. # 技术规划

     ## 总体技术框架

     <img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g8airfhtekj31440p27d6.jpg" alt="image-20191025162003204" style="zoom:68%;" />

  - [ ] 技术上，业务前台、中台和后台都以微服务方式实现。
  - [ ] 每个服务均需在统一的应用框架上实现业务逻辑。统一应用框架负责实现统一的数据输出，包括统一的告警日志、报文日志、系统日志、应用状态等，有效解耦、隔离业务逻辑和运维、数据中台等其他数据使用方。
  - [ ] 数据中台分层提供服务，最底层是基本是业务原始数据，最上层是特点数据应用相关的数据。
  - [ ] 不限制实现某个服务所用具体技术，但**要遵守底下原则**：
    - 所有服务均由服务治理组件统一管理
    - 所有业务相关服务均在统一应用框架上进行开发，不允许自行输出数据
    - 每个服务/中心内的数据，不允许其他服务直接问（除数据同步服务外）;各交易中心的后线库纳入对账中心管理
    - 非统计类查询（如对外服务查询某支付订单的状态），原则上可直接调用中台服务，由中台服务控制查询对交易的影响  

  6. # 部署规划

     ## 异地部署总体方案

     沿用“两地三中心”方案。IDC1和IDC2做实时交易的双活，IDC3做数据中台（兼顾数据冷备），具体分工如下：

     ![image-20191025162048049](https://tva1.sinaimg.cn/large/006y8mN6gy1g8ais7jmhbj30zi0miwhx.jpg)

     

     ## 逻辑分组&异地双活

     ### 主方案

     实时交易进行双活，其部署上仍然沿用分组策略，但分法稍有不同，具体原则：

     1. 每个逻辑组可独立完成实时交易的任务，不依赖与其他组 ;
     2. 每个逻辑组的实时数据是独立的，不共享。而配置类对延时性要求不高的数据可共享 ;
     3. 每个逻辑组在两个中心成对出现，数据双向同步
     4. 配置类服务，放在单独的逻辑组方便管理
     5. 实时逻辑组定期从配置服务组获取配置信息

     逻辑分组最大的作用是**灰度发布**；但分组太多会增加IDC间**数据同步的难度**，因此一个IDC同一类业务一个逻辑组够了。

     ![image-20191025162113239](https://tva1.sinaimg.cn/large/006y8mN6gy1g8aisn1on9j315q0i8jxk.jpg)

     > 1. 业界对逻辑分组的叫法不一样，阿里叫逻辑机房，腾讯叫Set。考虑我方团队的历史习惯，仍然以组称呼此类部署方案。

     *数据中台的数据怎么实时同步？*

     *移动商城重复？*

     ### 备方案

     如本规划实施时，有成熟的分布式关系型数据库支撑，则应用架构及数据架构更简单：业务应用只需按平常单机数据库存取数据；数据库负责异地数据备份、异地数据查询等负责操作；逻辑分组无需成对出现。

     ![image-20191025162149508](https://tva1.sinaimg.cn/large/006y8mN6gy1g8ait9yi6dj315q0i8jxg.jpg)

     > 阿里最保守的蚂蚁金服（仍用JDK1.6）已经全部迁移至此备方案了，说明分布式关系型数据库已经成熟。

     

     ## 异地同步/备份

     ### 近实时数据同步

     主要涉及订单状态的同步（部分系统也叫流水，后续统一用‘’‘订单“称呼）。有两种实现方式，分别是日志采集和通过消息进行同步。如果生产环境允许，优先考虑后者。

     ![image-20191105102252062](https://tva1.sinaimg.cn/large/006y8mN6gy1g8my98ilivj31d40a0wgj.jpg)

     ### 离线数据备份

     - 数据库备份

     <img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g8my9t2sxvj30oe096q4d.jpg" alt="image-20191105102329149" style="zoom:50%;" />

     - 对账/结算文件备份：与数据库备份类似，只是少了数据库导出文件这一步

     

  7. # 数据规划

     ##  数据流向

     ![image-20191106100544000](https://tva1.sinaimg.cn/large/006y8mN6gy1g8o3drcimhj31fc0menhw.jpg)
     
       ## 数据模型
     
     ​	以**Kimball的维度模型为核心**进行建模。
     
       > 参考《The Data Warehouse Lifecycle Toolkit 》、《The data WareHouse Tooklit-The *Complete Guide to* *Dimensional* Modeling》及《大数据之路：阿里巴巴大数据实践》。
     
     
     
  8. # 进度规划

     原则上是自底向上落地:

     - 服务治理
     - 后台
     - 业务中台复用度高的服务：用户中心、签到签退服务、号码查询/鉴权服务、虚户中心
     - 业务中台
     - 数据中台
     - 业务前台
     
     根据需求紧急度，以上可以并行、迭代式开发。
     
     除了数据中台外，其他均规划于2020年完成。
     
     
     

